var x=(r,u,l)=>new Promise((f,d)=>{var g=i=>{try{m(l.next(i))}catch(h){d(h)}},n=i=>{try{m(l.throw(i))}catch(h){d(h)}},m=i=>i.done?f(i.value):Promise.resolve(i.value).then(g,n);m((l=l.apply(r,u)).next())});import{j as s,O as _}from"./index-5a8bf324.js";import{d as ss,r as o}from"./vendor-2240c9f5.js";import{g as es,c as $,h as ts,a as p,N as Q,L as as,B as I,b as ns,A as R,i as O,j as os,R as is,E as rs}from"./ui-2716f190.js";import{I as E}from"./interestCollector-7eb40cd0.js";import"./remoteOllamaService-1d39e648.js";const cs="_container_xmh2s_1",ls="_messageList_xmh2s_15",ds="_messageItem_xmh2s_29",gs="_userMessage_xmh2s_41",us="_assistantMessage_xmh2s_51",ms="_messageAvatar_xmh2s_61",hs="_messageContent_xmh2s_71",xs="_messageText_xmh2s_83",ps="_messageTime_xmh2s_123",fs="_inputArea_xmh2s_153",_s="_input_xmh2s_153",js="_sendButton_xmh2s_181",vs="_loading_xmh2s_189",ws="_loadingDot_xmh2s_203",ys="_bounce_xmh2s_1",Cs="_historiesContainer_xmh2s_253",Ss="_historiesList_xmh2s_277",Is="_suggestedQuestions_xmh2s_287",Ns="_suggestedQuestion_xmh2s_287",As="_interestsButton_xmh2s_315",a={container:cs,messageList:ls,messageItem:ds,userMessage:gs,assistantMessage:us,messageAvatar:ms,messageContent:hs,messageText:xs,messageTime:ps,inputArea:fs,input:_s,sendButton:js,loading:vs,loadingDot:ws,bounce:ys,historiesContainer:Cs,historiesList:Ss,suggestedQuestions:Is,suggestedQuestion:Ns,interestsButton:As},Ts=r=>{switch(r){case 3:return"primary";case 2:return"success";default:return"default"}},Ls=r=>{switch(r){case 3:return"(热爱)";case 2:return"(喜欢)";default:return""}},Ds=({visible:r,interests:u,onClose:l,onAddTags:f,onImportToProfile:d})=>{const g={};return u.forEach(n=>{g[n.category]||(g[n.category]=[]),g[n.category].push(n)}),s.jsx(es,{visible:r,title:"您的兴趣标签",content:s.jsx("div",{style:{maxHeight:"60vh",overflow:"auto",padding:"12px 0"},children:u.length>0?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{marginBottom:"16px"},children:"根据我们的对话，您可能对以下内容感兴趣："}),Object.entries(g).map(([n,m])=>s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("div",{style:{fontSize:"16px",fontWeight:"bold",marginBottom:"8px"},children:n}),s.jsx($,{wrap:!0,children:m.map((i,h)=>s.jsxs(ts,{color:Ts(i.level),children:[i.name," ",Ls(i.level)]},h))})]},n)),s.jsx("div",{style:{marginTop:"16px",color:"#666",fontSize:"14px"},children:"这些兴趣标签可以帮助我更好地理解您的喜好，为您提供更个性化的服务。"})]}):s.jsx("div",{style:{textAlign:"center",padding:"20px 0",color:"#999"},children:"暂无兴趣标签，请继续进行对话..."})}),actions:[{key:"add-tags",text:"添加兴趣标签",onClick:f},{key:"import",text:"导入到个人信息",onClick:d},{key:"cancel",text:"取消",onClick:l}]})},Rs=()=>{const r=ss(),[u,l]=o.useState(""),[f,d]=o.useState([]),[g,n]=o.useState(!1),[m,i]=o.useState([]),[h,w]=o.useState(!1),[N,A]=o.useState(null),[z,T]=o.useState(!0),y=o.useRef(null),[c,q]=o.useState(null);o.useState(!1);const[D,F]=o.useState([]),M=o.useRef(null),[P,C]=o.useState(!1);o.useEffect(()=>{const e=localStorage.getItem("user")||sessionStorage.getItem("user");if(e){const t=JSON.parse(e);q(t.id),S(t.id),k(t.id)}else p.show({content:"请先登录",afterClose:()=>{r("/login")}})},[r]);const k=e=>x(void 0,null,function*(){try{n(!0);const t=yield _.get(`/api/ai/greeting/${e}`);if(t.data.success){const j=t.data.data.message;d([{role:"assistant",content:j,timestamp:new Date().toISOString()}]),U(e)}}catch(t){console.error("获取AI问候语失败:",t),p.show({content:"无法获取AI问候，请稍后再试"})}finally{n(!1)}}),U=(j,...b)=>x(void 0,[j,...b],function*(e,t=[]){try{const v=yield _.post("/api/ai/interest-questions",{user_id:e,current_interests:t});v.data.success&&F(v.data.data.questions)}catch(v){console.error("获取推荐问题失败:",v)}}),S=e=>x(void 0,null,function*(){try{const t=yield _.get(`/api/chat/history/user/${e}`);t.data.success&&i(t.data.data)}catch(t){console.error("获取聊天历史记录失败:",t)}}),V=e=>x(void 0,null,function*(){try{n(!0);const t=yield _.get(`/api/chat/history/${e}`);t.data.success&&(d(t.data.data.messages),A(e),T(!1),w(!1))}catch(t){console.error("加载聊天历史记录失败:",t),p.show({content:"无法加载聊天历史记录"})}finally{n(!1)}}),B=()=>{d([]),A(null),T(!0),w(!1),c&&k(c)},X=()=>x(void 0,null,function*(){if(!u.trim()||g||!c)return;const e={role:"user",content:u,timestamp:new Date().toISOString()},t=[...f,e];d(t),l(""),n(!0);try{let j="我正在处理您的请求...";setTimeout(()=>x(void 0,null,function*(){const b=["谢谢您的回复！我很高兴能与您交流。","感谢您的消息。请问还有什么我可以帮助您的吗？","我理解您的意思了。我们可以继续讨论这个话题，或者您想聊些别的？","我很期待更多地了解您的想法。请继续分享吧！"];j=b[Math.floor(Math.random()*b.length)];const v={role:"assistant",content:j,timestamp:new Date().toISOString()},L=[...t,v];if(d(L),z&&c){const H=yield _.post("/api/chat/history",{user_id:c,messages:L,title:`与AI助手的对话 - ${new Date().toLocaleString()}`});H.data.success&&(A(H.data.data.id),T(!1),S(c))}else N&&c&&(yield _.put(`/api/chat/history/${N}`,{user_id:c,messages:L}),S(c));n(!1),setTimeout(()=>{M.current&&M.current.scrollIntoView({behavior:"smooth"})},100),E.shouldShowInterestDialog()&&C(!0)}),1e3)}catch(j){console.error("发送消息失败:",j),n(!1),p.show({content:"发送消息失败，请稍后再试"})}}),G=e=>x(void 0,null,function*(){try{(yield _.delete(`/api/chat/history/${e}`)).data.success&&(N===e&&B(),c&&S(c),p.show({content:"聊天记录已删除"}))}catch(t){console.error("删除聊天历史记录失败:",t),p.show({content:"删除失败，请稍后再试"})}}),J=e=>{l(e)};o.useEffect(()=>{y.current&&(y.current.scrollTop=y.current.scrollHeight)},[f]);const W=()=>f.map((e,t)=>s.jsxs("div",{className:`${a.messageItem} ${e.role==="user"?a.userMessage:a.assistantMessage}`,children:[s.jsx("div",{className:a.messageAvatar,children:e.role==="user"?s.jsx(R,{src:"https://zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"}):s.jsx(R,{src:"/ai-avatar.png"})}),s.jsxs("div",{className:a.messageContent,children:[s.jsx("div",{className:a.messageText,children:e.content}),s.jsx("div",{className:a.messageTime,children:e.timestamp?new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""})]})]},t)),Y=()=>s.jsxs("div",{className:a.historiesContainer,children:[s.jsx(Q,{back:null,right:s.jsx(I,{size:"small",color:"primary",onClick:B,children:"新对话"}),onBack:()=>w(!1),children:"聊天记录"}),s.jsx("div",{className:a.historiesList,children:m.length>0?s.jsx(O,{children:m.map(e=>s.jsx(os,{rightActions:[{key:"delete",text:"删除",color:"danger",onClick:()=>G(e.id)}],children:s.jsx(O.Item,{onClick:()=>V(e.id),description:new Date(e.created_at).toLocaleString(),arrow:s.jsx(is,{}),children:e.title})},e.id))}):s.jsx(rs,{description:"暂无聊天记录"})})]}),K=()=>{C(!1),p.show({content:"即将上线，敬请期待"})},Z=()=>{C(!1),p.show({content:"兴趣标签已导入到个人资料"})};return s.jsxs("div",{className:a.container,children:[s.jsx(Q,{back:s.jsx(as,{}),onBack:()=>r(-1),right:s.jsx(I,{size:"small",onClick:()=>w(!0),children:"历史"}),children:"AI助手"}),h&&Y(),!h&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:a.messageList,ref:y,children:[W(),g&&s.jsxs("div",{className:a.loading,children:[s.jsx("div",{className:a.loadingDot}),s.jsx("div",{className:a.loadingDot}),s.jsx("div",{className:a.loadingDot})]})]}),D.length>0&&s.jsx("div",{className:a.suggestedQuestions,children:s.jsx($,{wrap:!0,children:D.map((e,t)=>s.jsx(I,{size:"mini",onClick:()=>J(e),className:a.suggestedQuestion,children:e},t))})}),s.jsxs("div",{className:a.inputArea,children:[s.jsx(ns,{placeholder:"输入消息...",value:u,onChange:l,className:a.input}),s.jsx(I,{color:"primary",disabled:!u.trim()||g,onClick:X,className:a.sendButton,children:"发送"})]})]}),s.jsx(Ds,{visible:P,interests:E.getInterests(),onClose:()=>C(!1),onAddTags:K,onImportToProfile:Z})]})};export{Rs as default};
