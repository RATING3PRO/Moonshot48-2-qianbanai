var v=(f,g,i)=>new Promise((_,m)=>{var p=c=>{try{n(i.next(c))}catch(o){m(o)}},x=c=>{try{n(i.throw(c))}catch(o){m(o)}},n=c=>c.done?_(c.value):Promise.resolve(c.value).then(p,x);n((i=i.apply(f,g)).next())});import{O as A,j as t}from"./index-5a8bf324.js";import{d as O,j as b,r as l}from"./vendor-2240c9f5.js";import{a as d,N as L,L as k,J as E,K as P,E as $,O as R,P as F,W as H,b as J,B as K,A as N,g as j}from"./ui-2716f190.js";const W="_chatContainer_q0n1z_1",G="_navbarTitle_q0n1z_15",Q="_statusText_q0n1z_29",V="_messageList_q0n1z_41",X="_loadingContainer_q0n1z_55",Y="_messageItem_q0n1z_71",Z="_selfMessage_q0n1z_83",U="_otherMessage_q0n1z_91",ee="_messageAvatar_q0n1z_99",te="_messageContent_q0n1z_107",se="_messageText_q0n1z_119",ae="_messageTime_q0n1z_161",ne="_inputArea_q0n1z_193",oe="_inputButtons_q0n1z_209",re="_inputButton_q0n1z_209",ie="_messageInput_q0n1z_231",ce="_sendButton_q0n1z_247",s={chatContainer:W,navbarTitle:G,statusText:Q,messageList:V,loadingContainer:X,messageItem:Y,selfMessage:Z,otherMessage:U,messageAvatar:ee,messageContent:te,messageText:se,messageTime:ae,inputArea:ne,inputButtons:oe,inputButton:re,messageInput:ie,sendButton:ce},ge=()=>{const f=O(),{friendId:g}=b(),i=l.useRef(null),[_,m]=l.useState([]),[p,x]=l.useState(""),[n,c]=l.useState(null),[o,C]=l.useState(null),[T,w]=l.useState(!0),[I,S]=l.useState(!1);l.useEffect(()=>{var r,u;const e=localStorage.getItem("user")||sessionStorage.getItem("user");if(!e){d.show({content:"请先登录",afterClose:()=>f("/login")});return}const a=JSON.parse(e);C({id:a.id,username:a.username||((r=a.profile)==null?void 0:r.display_name)||"",avatar:((u=a.profile)==null?void 0:u.avatar)||"https://via.placeholder.com/40"}),g&&(M(parseInt(g)),B(a.id,parseInt(g)))},[g,f]);const M=e=>v(void 0,null,function*(){var a,r;try{const u=yield A.get(`/api/user/profile/${e}`);if(u.data.success){const h=u.data.data;c({id:h.id,username:((a=h.profile)==null?void 0:a.display_name)||h.username,avatar:((r=h.profile)==null?void 0:r.avatar)||"https://via.placeholder.com/40",status:h.online_status||"offline",lastSeen:h.last_seen})}else d.show({content:"获取用户信息失败"})}catch(u){console.error("获取好友信息失败:",u),d.show({content:"获取好友信息失败"})}}),B=(e,a)=>v(void 0,null,function*(){w(!0);try{const r=[{id:1,sender_id:e,receiver_id:a,content:"您好！",type:"text",read:!0,created_at:new Date(Date.now()-36e5).toISOString()},{id:2,sender_id:a,receiver_id:e,content:"您好！请问有什么可以帮助您的吗？",type:"text",read:!0,created_at:new Date(Date.now()-35e5).toISOString()},{id:3,sender_id:e,receiver_id:a,content:"我想了解一下社区最近的活动安排",type:"text",read:!0,created_at:new Date(Date.now()-34e5).toISOString()},{id:4,sender_id:a,receiver_id:e,content:"好的，我们社区近期有几个活动：1. 本周六上午有太极拳教学 2. 下周二下午有手工艺品制作 3. 下周四有健康讲座。您对哪个感兴趣呢？",type:"text",read:!0,created_at:new Date(Date.now()-33e5).toISOString()}];m(r)}catch(r){console.error("获取聊天历史失败:",r),d.show({content:"获取聊天历史失败"})}finally{w(!1)}}),y=()=>v(void 0,null,function*(){if(!(!p.trim()||!o||!n)){S(!0);try{const e={id:Date.now(),sender_id:o.id,receiver_id:n.id,content:p.trim(),type:"text",read:!1,created_at:new Date().toISOString()};m([..._,e]),x(""),setTimeout(()=>{if(Math.random()>.5){const a={id:Date.now()+1,sender_id:n.id,receiver_id:o.id,content:"收到您的消息，稍后回复您！",type:"text",read:!1,created_at:new Date().toISOString()};m(r=>[...r,a])}S(!1)},1e3)}catch(e){console.error("发送消息失败:",e),d.show({content:"发送消息失败"}),S(!1)}}});l.useEffect(()=>{i.current&&(i.current.scrollTop=i.current.scrollHeight)},[_]);const q=e=>{const a=e.sender_id===(o==null?void 0:o.id);return t.jsxs("div",{className:`${s.messageItem} ${a?s.selfMessage:s.otherMessage}`,children:[!a&&t.jsx(N,{src:(n==null?void 0:n.avatar)||"https://via.placeholder.com/40",className:s.messageAvatar}),t.jsxs("div",{className:s.messageContent,children:[t.jsx("div",{className:s.messageText,children:e.content}),t.jsx("div",{className:s.messageTime,children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),a&&t.jsx(N,{src:(o==null?void 0:o.avatar)||"https://via.placeholder.com/40",className:s.messageAvatar})]},e.id)},z=[{key:"clear",text:"清空聊天记录"},{key:"block",text:"屏蔽该好友"},{key:"report",text:"举报"}],D=e=>{e==="clear"?j.confirm({content:"确定要清空所有聊天记录吗？",onConfirm:()=>{m([]),d.show({content:"聊天记录已清空"})}}):e==="block"?j.confirm({content:"确定要屏蔽该好友吗？屏蔽后将不再收到对方的消息。",onConfirm:()=>{d.show({content:"该好友已被屏蔽"})}}):e==="report"&&j.confirm({content:"确定要举报该好友吗？",onConfirm:()=>{d.show({content:"举报已提交，我们会尽快处理"})}})};return t.jsxs("div",{className:s.chatContainer,children:[t.jsx(L,{back:t.jsx(k,{}),onBack:()=>f(-1),right:t.jsx(E.Menu,{actions:z,onAction:e=>D(e.key),trigger:"click",children:t.jsx(P,{})}),children:n?t.jsxs("div",{className:s.navbarTitle,children:[t.jsx("span",{children:n.username}),t.jsx("span",{className:s.statusText,children:n.status==="online"?"在线":n.status==="busy"?"忙碌中":n.lastSeen?`${n.lastSeen}前在线`:"离线"})]}):"加载中..."}),t.jsx("div",{className:s.messageList,ref:i,children:T?t.jsx("div",{className:s.loadingContainer,children:"加载中..."}):_.length===0?t.jsx($,{description:"暂无消息"}):_.map(e=>q(e))}),t.jsxs("div",{className:s.inputArea,children:[t.jsxs("div",{className:s.inputButtons,children:[t.jsx(R,{className:s.inputButton}),t.jsx(F,{className:s.inputButton}),t.jsx(H,{className:s.inputButton})]}),t.jsx(J,{className:s.messageInput,placeholder:"请输入消息...",value:p,onChange:e=>x(e),onEnterPress:y}),t.jsx(K,{className:s.sendButton,color:"primary",disabled:!p.trim()||I,onClick:y,children:"发送"})]})]})};export{ge as default};
